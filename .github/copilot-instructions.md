# AI Stock Market Agent - Copilot Instructions

## Project Overview

**AI Stock Market Agent** is an automated stock market analysis system that scans predefined tickers for technical patterns, generates trading signals, and delivers alerts via Telegram/Slack. It runs on intraday data (15m candles) and stores historical signals in SQLite for performance tracking.

### Architecture Components

- **Core Engine** (`scan_and_chart.py`): Pulls OHLCV data via yfinance, calculates technical indicators (Bollinger Bands, ATR, ADX, RSI, EMAs), detects 4 signal patterns
- **Web Dashboard** (`dashboard.py`): Streamlit UI with signal table, interactive TradingView-style charts, scan history, win rate analytics
- **Database Layer** (`database.py`): SQLite persistence - scans, signals, price tracking, signal statistics
- **Schedulers** (`scheduler.py`, `telegram_bot.py`, `utils.py`): Automated runs and multi-channel alerts (Telegram/Slack)
- **Interactive Charts** (`interactive_charts.py`): Lightweight Charts library for responsive technical visualizations

### Configuration

All signal thresholds, ticker lists, indicators, and alert channels are defined in `config.yaml`. Modify this file to adjust scanning behavior without code changes. Technical indicator windows (BB=20, ADX=14, RSI=14) follow standard practices.

---

## Developer Workflow

### Running Scans

```bash
# One-time scan with console output, CSV export, charts
python scan_and_chart.py

# Launch web dashboard (Streamlit, auto-refresh every 15 mins)
streamlit run dashboard.py

# Start daily scheduler at market open (09:30 ET)
python scheduler.py

# Force immediate scan via scheduler
python scheduler.py --run-now
```

### Database Setup

```bash
# Initialize or reset database
python -c "from database import init_database; init_database()"

# Database stores: scans metadata, individual signals, price tracking for win rate calculation
# Query historical performance via dashboard tabs or SQL directly
```

### Environment Variables

Create `.env` file for alerts (optional):
```
SLACK_WEBHOOK_URL=https://hooks.slack.com/...
TELEGRAM_BOT_TOKEN=123456:ABC...
TELEGRAM_CHAT_ID=987654321
```

Telegram alerts are enabled by default in `config.yaml`; Slack is optional.

---

## Code Patterns & Conventions

### Signal Detection Pipeline

All 4 signal types are detected by independent functions in `scan_and_chart.py` following this pattern:

```python
def consolidating(df, cfg):
    # Last N candles have low volatility (Bollinger Band width, ATR, ADX)
    s = cfg["signals"]["consolidation"]
    t = df.tail(s["lookback"])
    return condition_check

def buy_the_dip(df, cfg):
    # RSI oversold, optionally price below lower Bollinger Band
    # Triggered when rsi <= config threshold
```

**Pattern**: Each function takes DataFrame and config dict, accesses relevant thresholds via `cfg["signals"][pattern_name]`, returns boolean. This makes signal tuning a config-only change.

### DataFrame Structure

After `add_indicators()`, all DataFrames include:
- OHLCV columns: `Open, High, Low, Close, Volume`
- Computed columns: `bb_high, bb_low, bb_width, atr_pct, adx, rsi, ema_20, ema_50, ema_200, vol_ma_20`
- Always use `.iloc[-1]` for latest candle (current bar)

### Signal Scoring

Each detected pattern increments a score in the results list. Final score drives dashboard badging (ðŸ”¥ 5+ = high priority). Score is stored in database for win rate tracking.

### Dashboard Data Flow

`dashboard.py` queries database via `get_recent_scans()`, `get_top_signals()`, `calculate_win_rates()`. Interactive charts are created by `create_interactive_chart(df, ticker)` which converts OHLCV + indicators to Lightweight Charts JSON format.

---

## Integration Points

### External Dependencies

- **yfinance**: Stock data fetching; handles multi-level columns after downloads (flatten in `get_clean_prices()`)
- **ta library**: Technical indicators (Bollinger Bands, ATR, ADX, RSI)
- **mplfinance**: Static candlestick chart generation with volume overlays
- **Streamlit**: Dashboard and UI components; auto-refresh timer in page config
- **requests**: Telegram and Slack API calls with 10-30 second timeouts

### Data Export

- `scan_results.csv`: Appended after each scan, columns = `Ticker, Score, Consolidating, BuyDip, Breakout, VolSpike, Trend, Price, RSI, ADX, BB_Width, ATR`
- `/charts` directory: PNG candlestick images, one per signal stock, auto-generated by `generate_signals_and_charts()`
- SQLite database: Designed for historical analysis, win rate queries, performance analytics

### Alert Formatting

Telegram message template in `format_scan_results()`: summary counts + top 5 stocks by score + emoji badges. Photos sent separately if `config.alerts.send_charts=true`. Slack uses simple text format via webhook.

---

## Key Files to Understand

- `scan_and_chart.py` (284 lines): Core scanning logic, indicator calculation, pattern detection, output formatting
- `config.yaml` (45 lines): Single source of truth for all thresholds and settings
- `database.py` (388 lines): Schema (scans, signals, price_tracking), query helpers, win rate calculation
- `dashboard.py` (624 lines): Streamlit UI, tabs (Signals, Charts, History, Analytics), real-time refresh
- `scheduler.py` (116 lines): Daily scheduling with timezone support, subprocess handling for robustness
- `telegram_bot.py` (216 lines): Bot class and message formatting
- `utils.py` (10 lines): Slack webhook helper (minimal)

---

## Testing & Debugging

- Modify `config.yaml` to test with fewer tickers or different intervals (e.g., `1h` instead of `15m`)
- Check `scan_results.csv` for detailed signal output after each run
- Review `stock_agent.db` tables directly: `sqlite3 stock_agent.db "SELECT * FROM signals LIMIT 5;"`
- Dashboard error panel shows Streamlit-level issues; scheduler logs subprocess stderr to console
- Telegram/Slack failures are logged but don't halt scans (graceful degradation)

---

## Common Customizations

1. **Change scan time**: Edit `config.yaml` `data.interval` (15m, 30m, 1h, 4h) or `data.period` (5d, 10d, 1mo)
2. **Add tickers**: Update `config.yaml` `tickers` list
3. **Adjust signal thresholds**: Modify values in `config.yaml` `signals.*` sections (e.g., `rsi_max: 35` for buy_the_dip)
4. **Change indicator windows**: Edit `config.yaml` `indicators.*` (bb_window, atr_window, etc.)
5. **Disable alerts**: Set `config.yaml` `alerts.telegram.enabled: false` or remove webhook env vars
6. **Add new signal pattern**: Create function in `scan_and_chart.py`, add config section, update `generate_signals()` accumulator

---

## Notes for AI Agents

- **Intraday focus**: System designed for 15m-1h candles and daily scans, not long-term analysis
- **Config-driven**: Before modifying code logic, check if adjustment exists in `config.yaml`
- **Idempotent signals**: Same ticker in multiple scans is fine; database tracks duplicates by date for analytics
- **Error resilience**: Missing data from yfinance, API failures, or timeouts don't crash the scanâ€”log and continue
